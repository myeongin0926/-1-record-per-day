# SOP 정책

### SOP?

`SOP` 은 동일 출처 정책이라고도 불리우며 `Same Origin Policy` 의 줄임말입니다.

브라우저는 사용자가 방문하는 사이트를 신뢰하지 않기 때문에

브라우저는 기본으로 내 서버가 아닌 다른 서버에서 받아온 데이터를 차단합니다.

그 이유로 기본적으로 브라우저는 토큰이나 쿠키 등과 같이 사용자의 정보와 관련된 데이터를 저장하는데

해커가 이를 탈취해 악의적인 행동을 할 수 있기에 이를 방지하기 위해 나온것이 동일 출처 정책 `SOP` 입니다.

`SOP`은 말 그대로 자신과 동일한 도메인만 서버로부터 데이터를 요청하여 받을 수 있도록 하는 정책입니다.

`https://korea.com`에서 보낸 요청은 서버의 응답은 `https://korea.com` 에서만 받을 수 있습니다.

### 브라우저는 SOP정책을 기본으로 합니다.

---

### 동일 출처와 교차출처

동일출처란 `schme` , `host`, `port` 이렇게 세 개가 같은 `URL` 을 동일 출처로 구분합니다.

`https://korea.com` 라는 `URL`을 가지고 동일 출처와 교차출처를 알아보도록 하겠습니다.

| URL | 출처 | 이유 |
| --- | --- | --- |
| https://korea.com/busan | 동일 출처 | schme, host, port 일치 |
| https://korea.com/busan?q=quert | 동일 출처 | schme, host, port 일치 |
| https://korea.com | 교차 출처 | schme 불일치 |
| https://korea.com | 교차 출처 | host 불일치 |
| https://korea.com:5000 | 교차출처 | port 불일치 
https의 기본 port는 443입니다. |

이러한 `SOP` 정책으로 인해 외부에서 데이터를 불러오는것이 불가능하지만 안전하다는 장점이 있습니다.

---

### 출처비교

출처를 비교하고 차단하는 역할은 서버에 구현된것이 아닌 브라우저에 구현된 스펙입니다.

![스크린샷 2023-05-29 오후 8.41.25.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/16c8fb5a-e579-4487-a516-8fa444a647b2/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2023-05-29_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_8.41.25.png)

조금 더 쉽게 말하자면 서버로 요청은 정상적으로 보내졌고 서버도 그에따라 올바른 응답을 보냅니다.

하지만 브라우저에서 출처를 비교하여 차단을 한 것이기에 서버는 정상 응답을 했다고 표시됩니다.

결론은 출처 비교와 차단은 브라우저가 진행합니다.

---

### CORS

`SOP` 라는 정책을 알아보았다 하지만 `SOP` 정책대로라면 외부에서 데이터를 절대 받아오지 못 할 것입니다.

데이터를 받아와야 할 때 제어된 조건에서 교차 출처 요청을 활성화할 수 있게 해주는것이 `CORS` 메커니즘입니다.

### 쉽게말해 SOP 정책을 위반해도 CORS 정책에 따르면 다른 출처의 리소스라도 허용합니다.

---

### CORS 동작원리

1. 클라이언트에서 `HTTP` 요청의 헤더에 `Origin(출처)` 를 담아서 전달합니다.
    
    ![스크린샷 2023-05-29 오후 8.48.32.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/cb7967eb-5cec-485b-88da-50a59514bfbc/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2023-05-29_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_8.48.32.png)
    

1. 서버는 응답헤더에 `Access-Control-Allow-Origin` 담아 클라이언트로 전달합니다.

     `Access-Control-Allow-Origin` - 해당 리소스에 접근이 허용된 `url` 주소를 담고 있습니다.

![스크린샷 2023-05-29 오후 8.50.44.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/37a5145e-f718-4b02-b63d-47483d8d43a2/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2023-05-29_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_8.50.44.png)

1. 클라이언트에서 `Origin`과 서버가 보내준 `Access-Control-Allow-Origin` 을 비교한다.
    - 응답을 받은 브라우저는 자신이 보냈던 요청의 `Origin`과 서버가 보내준 응답의
    
            `Access-Control-Allow-Origin`을 비교해본 후 차단 여부를 결정한다.
    
            유효하지 않다면 CORS 에러를 발생시키고 유효하다면 가져올 수 있게 된다.